<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload Students CSV</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body class="bg-light">

<div class="container mt-5">
  <h3 class="text-primary mb-4">Upload Students via CSV</h3>

  <!-- Flash & Error Messages (Unified) -->
  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} alert-dismissible fade show flash" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- CSV Upload Form -->
  <div class="card shadow-sm p-4 mb-4">
    <form method="POST" enctype="multipart/form-data">
      {{ form.hidden_tag() }}
      <div class="mb-3">
        {{ form.file.label(class="form-label") }}
        {{ form.file(class="form-control", accept=".csv", required=True) }}
      </div>
      <button type="submit" class="btn btn-success w-100">Upload CSV</button>
    </form>
    <!-- Back button inside the card -->
    <a href="{% if session.get('role') == 'Admin' %}{{ url_for('dashboard_admin') }}
             {% elif session.get('role') == 'Instructor' %}{{ url_for('dashboard_instructor') }}
             {% else %}{{ url_for('students') }}{% endif %}" 
       class="btn btn-secondary mt-3 w-100">Back to Dashboard</a>
  </div>

  <!-- Upload Summary with collapsible sections -->
  {% if summary %}
  <div class="card shadow-sm p-4 mb-4">
    <h5 class="text-primary mb-3">Upload Summary</h5>

    {% if summary.added %}
      <p>
        <a class="btn btn-success w-100 mb-2" data-bs-toggle="collapse" href="#addedStudents" role="button" aria-expanded="false" aria-controls="addedStudents">
          Added Students ({{ summary.added|length }})
        </a>
      </p>
      <div class="collapse" id="addedStudents">
        <ul class="list-group mb-3">
          {% for student in summary.added %}
            <li class="list-group-item list-group-item-success">{{ student }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if summary.updated %}
      <p>
        <a class="btn btn-warning w-100 mb-2" data-bs-toggle="collapse" href="#updatedStudents" role="button" aria-expanded="false" aria-controls="updatedStudents">
          Updated Students ({{ summary.updated|length }})
        </a>
      </p>
      <div class="collapse" id="updatedStudents">
        <ul class="list-group mb-3">
          {% for student in summary.updated %}
            <li class="list-group-item list-group-item-warning">{{ student }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

    {% if summary.skipped %}
      <p>
        <a class="btn btn-secondary w-100 mb-2" data-bs-toggle="collapse" href="#skippedStudents" role="button" aria-expanded="false" aria-controls="skippedStudents">
          Skipped / Duplicates ({{ summary.skipped|length }})
        </a>
      </p>
      <div class="collapse" id="skippedStudents">
        <ul class="list-group">
          {% for student in summary.skipped %}
            <li class="list-group-item list-group-item-secondary">{{ student }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}

  </div>
  {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Auto-hide flash messages
  document.addEventListener("DOMContentLoaded", function() {
    document.querySelectorAll(".flash").forEach(flash => {
      setTimeout(() => {
        flash.style.transition = "opacity 0.5s ease, transform 0.5s ease";
        flash.style.opacity = "0";
        flash.style.transform = "translateY(-10px)";
        setTimeout(() => flash.remove(), 500);
      }, 4000);
    });
  });
</script>

</body>
</html>
